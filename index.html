<!-- Made by Orbinuity company PLEASE read the license -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web Peeking</title>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            line-height: 1.6;
        }
        header {
            background-color: #333;
            color: white;
            text-align: center;
            padding: 1rem;
        }
        main {
            max-width: 800px;
            margin: 20px auto;
            padding: 0 20px;
        }
        footer {
            background-color: #333;
            color: white;
            text-align: center;
            padding: 1rem;
            position: fixed;
            bottom: 0;
            width: 100%;
        }
        #camera-feed {
            width: 100%;
            max-width: 640px;
            margin: 20px auto;
            display: block;
        }
        .error-message {
            color: red;
            text-align: center;
        }
        .controls {
            text-align: center;
            margin: 20px 0;
        }
        #peer-id {
            padding: 5px;
            margin: 5px;
        }
        button {
            padding: 8px 16px;
            margin: 5px;
        }
    </style>
</head>
<body>
    <header>
        <h1>Web Peeking</h1>
    </header>

    <main>
        <div class="controls">
            <div>
                Your ID: <span id="my-id">Connecting...</span>
            </div>
            <div>
                <input type="text" id="peer-id" placeholder="Enter peer ID" maxlength="4">
                <button id="connect-btn">Connect</button>
            </div>
            <button id="share-btn" disabled>Share Camera</button>
            <button id="stop-btn" disabled>Stop Sharing</button>
        </div>
        <video id="camera-feed" autoplay playsinline></video>
        <p id="error-message" class="error-message"></p>
    </main>

    <footer>
        <p>&copy; 2024 Orbinuity. All rights reserved.</p>
    </footer>

    <script>
        // Generate a random 4-character ID
        function generateShortId() {
            return Math.random().toString(36).substring(2, 6).toUpperCase();
        }

        let peer = new Peer(generateShortId());
        let currentCall = null;
        let localStream = null;
        let connectedPeerId = null;

        peer.on('open', (id) => {
            document.getElementById('my-id').textContent = id;
        });

        peer.on('call', async (call) => {
            // Only accept calls from the peer we're connected to
            if (call.peer === connectedPeerId) {
                handleStream(call);
                call.answer(); // Answer without sending our stream
            }
        });

        document.getElementById('connect-btn').addEventListener('click', async () => {
            const peerId = document.getElementById('peer-id').value.toUpperCase();
            if (peerId.length !== 4) {
                document.getElementById('error-message').textContent = 'ID must be 4 characters';
                return;
            }

            connectedPeerId = peerId;
            document.getElementById('share-btn').disabled = false;
            document.getElementById('error-message').textContent = 'Connected! Click Share Camera to start sharing.';
        });

        document.getElementById('share-btn').addEventListener('click', async () => {
            if (!connectedPeerId) return;
            
            try {
                localStream = await navigator.mediaDevices.getUserMedia({ video: true });
                const call = peer.call(connectedPeerId, localStream);
                document.getElementById('share-btn').disabled = true;
                document.getElementById('stop-btn').disabled = false;
                document.getElementById('camera-feed').srcObject = localStream;
            } catch (err) {
                document.getElementById('error-message').textContent = 
                    'Error accessing camera: ' + err.message;
            }
        });

        document.getElementById('stop-btn').addEventListener('click', () => {
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                document.getElementById('camera-feed').srcObject = null;
                document.getElementById('share-btn').disabled = false;
                document.getElementById('stop-btn').disabled = true;
            }
            if (currentCall) {
                currentCall.close();
            }
            connectedPeerId = null;
        });

        function handleStream(call) {
            currentCall = call;
            call.on('stream', (remoteStream) => {
                document.getElementById('camera-feed').srcObject = remoteStream;
            });
            call.on('close', () => {
                document.getElementById('camera-feed').srcObject = null;
            });
        }
    </script>
</body>
</html>
